<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENGR4451 - Yoklama Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .qr-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .qr-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .qr-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .qr-code {
            margin: 15px auto;
            display: inline-block;
        }
        
        .success-msg, .error-msg {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .failed {
            background: #ffebee !important;
            color: #c62828;
            font-weight: bold;
        }
        
        .week-cell {
            text-align: center;
            font-size: 0.9em;
        }
        
        .present {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .absent {
            color: #c62828;
        }
        
        .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
        }
        
        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .test-form {
            background: #fff3cd;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #ffc107;
        }

        .test-form h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ENGR4451</h1>
            <p>MÃ¼hendislik UygulamalarÄ± iÃ§in Ãœretken Yapay Zeka</p>
            <p style="font-size: 0.9em; color: #999; margin-top: 10px;">SalÄ± 12:40-15:30</p>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="instructor">ğŸ‘¨â€ğŸ« Ã–ÄŸretmen Paneli</button>
            <button class="tab-btn" data-tab="student">ğŸ“± Ã–ÄŸrenci Yoklama</button>
            <button class="tab-btn" data-tab="reports">ğŸ“Š Raporlar</button>
        </div>
        
        <!-- INSTRUCTOR PANEL -->
        <div id="instructor" class="tab-content active">
            <div id="teacherLogin" style="max-width: 500px; margin: 0 auto; text-align: center;">
                <div style="background: #fff3cd; padding: 30px; border-radius: 15px; border: 2px solid #ffc107;">
                    <h2 style="color: #856404; margin-bottom: 20px;">ğŸ”’ Ã–ÄŸretmen GiriÅŸi</h2>
                    <p style="margin-bottom: 20px; color: #666;">Bu panel sadece Ã¶ÄŸretmen iÃ§indir. LÃ¼tfen ÅŸifrenizi girin:</p>
                    
                    <div class="form-group">
                        <input type="password" id="teacherPasswordInput" placeholder="Åifre" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; text-align: center;">
                    </div>
                    
                    <button class="btn" id="teacherLoginBtn">ğŸ”“ GiriÅŸ Yap</button>
                    <div id="loginError"></div>
                </div>
            </div>
            
            <div id="teacherPanel" style="display: none;">
                <div class="info-box">
                    <h3>ğŸ“‹ Sistem Bilgileri</h3>
                    <p><strong>Toplam Ã–ÄŸrenci:</strong> 42 kiÅŸi</p>
                    <p><strong>Toplam Hafta:</strong> 15 hafta</p>
                    <p><strong>Minimum KatÄ±lÄ±m:</strong> %70 (11 hafta)</p>
                    <p><strong>QR Kod Aktif Saati:</strong> SalÄ± 12:40-15:30</p>
                </div>
                
                <div style="background: #e8f5e9; padding: 25px; border-radius: 15px; margin: 20px 0; border: 3px solid #4caf50;">
                    <h2 style="color: #2e7d32; margin-bottom: 20px;">ğŸ“… Aktif Hafta QR Kodu</h2>
                    
                    <div class="form-group">
                        <label style="font-size: 1.2em; color: #333;">Hangi haftanÄ±n QR kodunu gÃ¶stermek istersiniz?</label>
                        <select id="activeWeekSelect" style="width: 100%; padding: 15px; border: 2px solid #4caf50; border-radius: 8px; font-size: 1.1em; margin-top: 10px;">
                            <option value="">Hafta SeÃ§in...</option>
                        </select>
                    </div>
                    
                    <div id="activeQRDisplay" style="text-align: center; margin-top: 30px;"></div>
                </div>
                
                <details style="margin-top: 30px;">
                    <summary style="cursor: pointer; padding: 15px; background: #f5f5f5; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                        ğŸ“š TÃ¼m HaftalÄ±k QR KodlarÄ± (Yedek)
                    </summary>
                    <div class="qr-grid" id="qrGrid" style="margin-top: 20px;"></div>
                </details>
                
                <button class="btn" id="logoutBtn" style="background: #dc3545; margin-top: 20px;">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </div>
        
        <!-- STUDENT PANEL -->
        <div id="student" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“± Yoklama QR Kod Tarama</h2>
            
            <div class="info-box">
                <h3>â„¹ KullanÄ±m TalimatlarÄ±</h3>
                <p>1. Ã–nce Ã¶ÄŸrenci numaranÄ±zÄ± girin</p>
                <p>2. "KamerayÄ± BaÅŸlat" butonuna tÄ±klayÄ±n</p>
                <p>3. HocanÄ±n gÃ¶sterdiÄŸi QR kodu kameranÄ±za tutun</p>
                <p><strong>Ã–nemli:</strong> Her hafta sadece bir kez tarayabilirsiniz!</p>
            </div>

            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 5px solid #4caf50;">
                <h3 style="color: #2e7d32; margin-bottom: 10px;">ğŸ“· QR Kod Okuyucu</h3>
                
                <div class="form-group">
                    <label>Ã–ÄŸrenci NumaranÄ±z:</label>
                    <input type="text" id="studentNoInput" placeholder="Ã–rn: 21070008009" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em;">
                </div>
                
                <button class="btn" id="startScanBtn">ğŸ“· KamerayÄ± BaÅŸlat</button>
                <button class="btn" id="stopScanBtn" style="background: #dc3545; display: none;">â¹ KamerayÄ± Durdur</button>
                
                <div id="qrReader" style="margin-top: 20px;"></div>
                <div id="qrResult"></div>
            </div>
            
            <div class="test-form">
                <div id="testModeLogin">
                    <h3>ğŸ§ª Test Modu</h3>
                    <p style="margin-bottom: 20px; color: #666;">Test modu sadece Ã¶ÄŸretmen iÃ§indir.</p>
                    
                    <div class="form-group">
                        <input type="password" id="testPasswordInput" placeholder="Ã–ÄŸretmen Åifresi" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em;">
                    </div>
                    
                    <button class="btn" id="testLoginBtn">ğŸ”“ Test Moduna Gir</button>
                    <div id="testLoginError"></div>
                </div>
                
                <div id="testModePanel" style="display: none;">
                    <h3>ğŸ§ª Test Modu - Manuel Yoklama</h3>
                    <p style="margin-bottom: 20px; color: #666;">Kamera yoksa manuel test yapÄ±n:</p>
                    
                    <div class="form-group">
                        <label>Hafta SeÃ§in:</label>
                        <select id="weekSelect">
                            <option value="">Hafta SeÃ§in...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ã–ÄŸrenci SeÃ§in:</label>
                        <select id="studentSelect">
                            <option value="">Ã–ÄŸrenci SeÃ§in...</option>
                        </select>
                    </div>
                    
                    <button class="btn" id="markAttendanceBtn">âœ… Yoklama Ä°ÅŸaretle</button>
                    <button class="btn" id="testLogoutBtn" style="background: #dc3545;">ğŸšª Test Modundan Ã‡Ä±k</button>
                    
                    <div id="testResult"></div>
                </div>
            </div>
        </div>
        
        <!-- REPORTS PANEL -->
        <div id="reports" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š DevamsÄ±zlÄ±k Raporu</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalStudents">42</h3>
                    <p>Toplam Ã–ÄŸrenci</p>
                </div>
                <div class="stat-card">
                    <h3 id="passedStudents">42</h3>
                    <p>GeÃ§en Ã–ÄŸrenci</p>
                </div>
                <div class="stat-card">
                    <h3 id="failedStudents">0</h3>
                    <p>Kalan Ã–ÄŸrenci</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgAttendance">0%</h3>
                    <p>Ortalama KatÄ±lÄ±m</p>
                </div>
            </div>
            
            <button class="btn" id="exportBtn">ğŸ“¥ Excel'e Aktar</button>
            
            <div class="table-wrapper">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Ã–ÄŸrenci No</th>
                            <th>Ad Soyad</th>
                            <th>BÃ¶lÃ¼m</th>
                            <th>H1</th>
                            <th>H2</th>
                            <th>H3</th>
                            <th>H4</th>
                            <th>H5</th>
                            <th>H6</th>
                            <th>H7</th>
                            <th>H8</th>
                            <th>H9</th>
                            <th>H10</th>
                            <th>H11</th>
                            <th>H12</th>
                            <th>H13</th>
                            <th>H14</th>
                            <th>H15</th>
                            <th>KatÄ±lÄ±m</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const students = [
            {no: "18070003013", name: "Ä°BRAHÄ°M GÃœLTEKÄ°N", dept: "Ä°NÅAAT MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "19070001053", name: "ELÄ°F EMÄ°NE GÃœNAL", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "19070008012", name: "ERK YANKI URAL", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070001057", name: "ERCE Ã–ZKAN", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070002048", name: "Ä°PEK ATIÅ", dept: "ENDÃœSTRÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070007004", name: "Ä°DÄ°L ECE CEVAHÄ°R", dept: "ENERJÄ° SÄ°STEMLERÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070008016", name: "SUDE ONFÄ°DAN", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070008017", name: "Ã–MER ARICA", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070008019", name: "SELÄ°M MERT KIRCAALÄ°LÄ°", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "20070008029", name: "BERÄ°L DERAN GÃœRBÃœZ", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070001004", name: "ALÄ° HAKTAN SIÄIN", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070001046", name: "AHMET Ã–ZGÃœR KORKMAZ", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070001051", name: "ARDA ALTUNHAN", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070001070", name: "EKREM TEMEL", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070002005", name: "NESRÄ°N ÅENTÃœRK", dept: "ENDÃœSTRÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070002025", name: "BATUHAN ÅÄ°ÅMAN", dept: "ENDÃœSTRÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070005027", name: "KIVANÃ‡ EFE ERGÃ–NÃœL", dept: "ELEKTRÄ°K-ELEKTRONÄ°K MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070005030", name: "OÄUZ KOYUCAN", dept: "ELEKTRÄ°K-ELEKTRONÄ°K MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070005042", name: "ZEYNEP ARSLANBUÄA", dept: "ELEKTRÄ°K-ELEKTRONÄ°K MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070007001", name: "BESTE TEKÄ°N", dept: "ENERJÄ° SÄ°STEMLERÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070007004", name: "EKÄ°N ALTUNKAYA", dept: "ENERJÄ° SÄ°STEMLERÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008009", name: "EMRE ERÄ°ÅÄ°R", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008014", name: "Ä°SMAÄ°L CANBERK DEMÄ°RKAN", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008016", name: "CAN GÄ°RGÄ°N", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008017", name: "KEREM EROÄLU", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008027", name: "ARMAÄAN SOYLU", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008033", name: "ALP SERKAN MERKÄ°T", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008034", name: "ATAKAN DÄ°NÃ‡ER", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "21070008206", name: "DEMET BÃœYÃœKTAÅ", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070001041", name: "GÃœRKAN EROÄLU", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070001055", name: "EMRE EFE YÃœKSEL", dept: "BÄ°LGÄ°SAYAR MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070002015", name: "SÃœLEYMAN BATU SARI", dept: "ENDÃœSTRÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070002047", name: "KADÄ°R EMRE GÃœNEÅ", dept: "ENDÃœSTRÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070003022", name: "AYÅEGÃœL KARINYARICI", dept: "Ä°NÅAAT MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070005040", name: "TOPRAK TUNCER", dept: "ELEKTRÄ°K-ELEKTRONÄ°K MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070005053", name: "EMRE CAN HEKÄ°MOÄLU", dept: "ELEKTRÄ°K-ELEKTRONÄ°K MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070007014", name: "ILGAR ÅENOL", dept: "ENERJÄ° SÄ°STEMLERÄ° MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070008017", name: "EDA NUR Ã‡ALIÅKAN", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070008021", name: "SAMÄ° BERK ÅAHÄ°N", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070008026", name: "DENÄ°Z ÃœNVER", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070008034", name: "AYKAN KANLI", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"},
            {no: "22070008043", name: "DENÄ°Z KARATEPE", dept: "MAKÄ°NE MÃœHENDÄ°SLÄ°ÄÄ°"}
        ];

        let attendanceData = {};
        let html5QrcodeScanner = null;
        let isScanning = false;
        let isTeacherLoggedIn = false;
        let isTestModeActive = false;
        const teacherPassword = 'ENGR4451admin';
        
        function initAttendanceData() {
            const saved = localStorage.getItem('attendanceData');
            if (saved) {
                attendanceData = JSON.parse(saved);
            } else {
                students.forEach(function(student) {
                    attendanceData[student.no] = Array(15).fill(0);
                });
            }
        }
        
        function saveAttendanceData() {
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
        }

        function generateQRCodes() {
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            
            for (let week = 1; week <= 15; week++) {
                const card = document.createElement('div');
                card.className = 'qr-card';
                card.innerHTML = '<h3>Hafta ' + week + '</h3><div id="qr' + week + '" class="qr-code"></div><p style="font-size: 0.9em; color: #666; margin-top: 10px;">Tarih: ' + getWeekDate(week) + '</p>';
                grid.appendChild(card);
                
                (function(w) {
                    setTimeout(function() {
                        const qrData = 'ENGR4451-W' + w + '-TOKEN';
                        try {
                            new QRCode(document.getElementById('qr' + w), {
                                text: qrData,
                                width: 180,
                                height: 180
                            });
                        } catch(e) {
                            console.error('QR Code generation error for week ' + w, e);
                        }
                    }, 100 * w);
                })(week);
            }
        }

        function getWeekDate(week) {
            const startDate = new Date('2024-09-24');
            const weekDate = new Date(startDate);
            weekDate.setDate(startDate.getDate() + (week - 1) * 7);
            return weekDate.toLocaleDateString('tr-TR');
        }

        function populateSelects() {
            const weekSelect = document.getElementById('weekSelect');
            const studentSelect = document.getElementById('studentSelect');
            const activeWeekSelect = document.getElementById('activeWeekSelect');
            
            for (let i = 1; i <= 15; i++) {
                const option1 = document.createElement('option');
                option1.value = i;
                option1.textContent = 'Hafta ' + i;
                weekSelect.appendChild(option1.cloneNode(true));
                
                const option2 = document.createElement('option');
                option2.value = i;
                option2.textContent = 'Hafta ' + i + ' - ' + getWeekDate(i);
                activeWeekSelect.appendChild(option2);
            }
            
            students.forEach(function(student) {
                const option = document.createElement('option');
                option.value = student.no;
                option.textContent = student.name + ' (' + student.no + ')';
                studentSelect.appendChild(option);
            });
        }

        function updateReports() {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';
            
            let passedCount = 0;
            let failedCount = 0;
            let totalAttendance = 0;
            
            students.forEach(function(student, index) {
                const attendance = attendanceData[student.no] || Array(15).fill(0);
                const presentCount = attendance.filter(function(a) { return a === 1; }).length;
                const percentage = ((presentCount / 15) * 100).toFixed(1);
                const status = presentCount >= 11 ? '' : 'DevamsÄ±zlÄ±ktan KaldÄ±';
                
                if (presentCount >= 11) passedCount++;
                else failedCount++;
                
                totalAttendance += presentCount;
                
                const row = document.createElement('tr');
                if (status) {
                    row.className = 'failed';
                }
                
                let weekCells = '';
                for (let i = 0; i < 15; i++) {
                    const mark = attendance[i] === 1 ? 'âœ“' : '-';
                    const cellClass = attendance[i] === 1 ? 'present' : 'absent';
                    weekCells += '<td class="week-cell ' + cellClass + '">' + mark + '</td>';
                }
                
                row.innerHTML = '<td>' + (index + 1) + '</td><td>' + student.no + '</td><td>' + student.name + '</td><td>' + student.dept + '</td>' + weekCells + '<td><strong>' + presentCount + '/15 (' + percentage + '%)</strong></td><td><strong>' + status + '</strong></td>';
                
                tbody.appendChild(row);
            });
            
            document.getElementById('passedStudents').textContent = passedCount;
            document.getElementById('failedStudents').textContent = failedCount;
            const avgAttendance = ((totalAttendance / (students.length * 15)) * 100).toFixed(1);
            document.getElementById('avgAttendance').textContent = avgAttendance + '%';
        }

        function exportToExcel() {
            let csv = '\uFEFFNo,Ã–ÄŸrenci No,Ad Soyad,BÃ¶lÃ¼m,';
            for (let i = 1; i <= 15; i++) {
                csv += 'Hafta ' + i + ',';
            }
            csv += 'KatÄ±lÄ±m,YÃ¼zde,Durum\n';
            
            students.forEach(function(student, index) {
                const attendance = attendanceData[student.no] || Array(15).fill(0);
                const presentCount = attendance.filter(function(a) { return a === 1; }).length;
                const percentage = ((presentCount / 15) * 100).toFixed(1);
                const status = presentCount >= 11 ? '' : 'DevamsÄ±zlÄ±ktan KaldÄ±';
                
                csv += (index + 1) + ',"' + student.no + '","' + student.name + '","' + student.dept + '",';
                attendance.forEach(function(a) {
                    csv += (a === 1 ? 'âœ“' : '-') + ',';
                });
                csv += presentCount + '/15,' + percentage + '%,' + status + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ENGR4451_Yoklama_Raporu.csv';
            link.click();
        }

        function showMessage(msg, type, targetId) {
            const target = document.getElementById(targetId);
            target.innerHTML = '<div class="' + type + '-msg">' + msg + '</div>';
            
            setTimeout(function() {
                target.innerHTML = '';
            }, 5000);
        }

        function processQRScan(qrData) {
            const studentNo = document.getElementById('studentNoInput').value.trim();
            
            if (!studentNo) {
                showMessage('âŒ LÃ¼tfen Ã¶nce Ã¶ÄŸrenci numaranÄ±zÄ± girin!', 'error', 'qrResult');
                return;
            }
            
            const student = students.find(function(s) { return s.no === studentNo; });
            if (!student) {
                showMessage('âŒ Ã–ÄŸrenci numarasÄ± bulunamadÄ±!', 'error', 'qrResult');
                return;
            }
            
            if (!qrData.startsWith('ENGR4451-W')) {
                showMessage('âŒ GeÃ§ersiz QR kod! Bu ders iÃ§in geÃ§erli bir QR kod deÄŸil.', 'error', 'qrResult');
                return;
            }
            
            const weekMatch = qrData.match(/W(\d+)/);
            if (!weekMatch) {
                showMessage('âŒ QR kod formatÄ± hatalÄ±!', 'error', 'qrResult');
                return;
            }
            
            const week = parseInt(weekMatch[1]);
            
            if (attendanceData[studentNo][week - 1] === 1) {
                showMessage('âš  Bu hafta iÃ§in yoklamanÄ±z zaten alÄ±nmÄ±ÅŸ!', 'error', 'qrResult');
                return;
            }
            
            attendanceData[studentNo][week - 1] = 1;
            saveAttendanceData();
            
            let weeklyCount = 0;
            students.forEach(function(s) {
                if (attendanceData[s.no] && attendanceData[s.no][week - 1] === 1) {
                    weeklyCount++;
                }
            });
            
            showMessage('âœ… Yoklama baÅŸarÄ±lÄ±! ' + student.name + ' - Hafta ' + week + '<br><strong>ğŸ“Š Bu hafta toplam ' + weeklyCount + ' kiÅŸi yoklama yaptÄ± (42 kiÅŸiden)</strong>', 'success', 'qrResult');
            updateReports();
            
            if (html5QrcodeScanner && isScanning) {
                stopQRScanner();
            }
        }

        function startQRScanner() {
            const studentNo = document.getElementById('studentNoInput').value.trim();
            if (!studentNo) {
                alert('LÃ¼tfen Ã¶nce Ã¶ÄŸrenci numaranÄ±zÄ± girin!');
                return;
            }
            
            if (isScanning) return;
            
            const qrReader = document.getElementById('qrReader');
            qrReader.innerHTML = '';
            
            html5QrcodeScanner = new Html5Qrcode("qrReader");
            
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                function(decodedText) {
                    processQRScan(decodedText);
                },
                function(errorMessage) {
                    // Silent error
                }
            ).then(function() {
                isScanning = true;
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-block';
            }).catch(function(err) {
                showMessage('âŒ Kamera baÅŸlatÄ±lamadÄ±: ' + err, 'error', 'qrResult');
            });
        }

        function stopQRScanner() {
            if (html5QrcodeScanner && isScanning) {
                html5QrcodeScanner.stop().then(function() {
                    html5QrcodeScanner.clear();
                    isScanning = false;
                    document.getElementById('startScanBtn').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    document.getElementById('qrReader').innerHTML = '';
                }).catch(function(err) {
                    console.error('Scanner stop error:', err);
                });
            }
        }

        function teacherLogin() {
            const password = document.getElementById('teacherPasswordInput').value;
            
            if (password === teacherPassword) {
                isTeacherLoggedIn = true;
                document.getElementById('teacherLogin').style.display = 'none';
                document.getElementById('teacherPanel').style.display = 'block';
            } else {
                showMessage('âŒ HatalÄ± ÅŸifre! LÃ¼tfen tekrar deneyin.', 'error', 'loginError');
            }
        }

        function teacherLogout() {
            isTeacherLoggedIn = false;
            document.getElementById('teacherLogin').style.display = 'block';
            document.getElementById('teacherPanel').style.display = 'none';
            document.getElementById('teacherPasswordInput').value = '';
            document.getElementById('activeQRDisplay').innerHTML = '';
        }

        function displayActiveWeekQR() {
            const week = parseInt(document.getElementById('activeWeekSelect').value);
            const display = document.getElementById('activeQRDisplay');
            
            if (!week) {
                display.innerHTML = '';
                return;
            }
            
            display.innerHTML = '<div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);"><h2 style="color: #2e7d32; margin-bottom: 20px;">Hafta ' + week + '</h2><div id="activeQR"></div><p style="font-size: 1.2em; color: #666; margin-top: 20px;"><strong>Tarih:</strong> ' + getWeekDate(week) + '</p><p style="font-size: 1em; color: #999; margin-top: 10px;">Bu QR kodu Ã¶ÄŸrencilere gÃ¶sterin</p></div>';
            
            setTimeout(function() {
                const qrData = 'ENGR4451-W' + week + '-TOKEN';
                try {
                    new QRCode(document.getElementById('activeQR'), {
                        text: qrData,
                        width: 300,
                        height: 300
                    });
                } catch(e) {
                    console.error('Active QR generation error:', e);
                }
            }, 100);
        }

        function testModeLogin() {
            const password = document.getElementById('testPasswordInput').value;
            
            if (password === teacherPassword) {
                isTestModeActive = true;
                document.getElementById('testModeLogin').style.display = 'none';
                document.getElementById('testModePanel').style.display = 'block';
            } else {
                showMessage('âŒ HatalÄ± ÅŸifre! Test modu sadece Ã¶ÄŸretmen iÃ§indir.', 'error', 'testLoginError');
            }
        }

        function testModeLogout() {
            isTestModeActive = false;
            document.getElementById('testModeLogin').style.display = 'block';
            document.getElementById('testModePanel').style.display = 'none';
            document.getElementById('testPasswordInput').value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            initAttendanceData();
            generateQRCodes();
            populateSelects();
            updateReports();
            
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab-content').forEach(function(content) {
                        content.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-btn').forEach(function(b) {
                        b.classList.remove('active');
                    });
                    
                    document.getElementById(tabName).classList.add('active');
                    this.classList.add('active');
                });
            });
            
            document.getElementById('markAttendanceBtn').addEventListener('click', function() {
                const week = parseInt(document.getElementById('weekSelect').value);
                const studentNo = document.getElementById('studentSelect').value;
                
                if (!week || !studentNo) {
                    showMessage('âŒ LÃ¼tfen hafta ve Ã¶ÄŸrenci seÃ§in!', 'error', 'testResult');
                    return;
                }
                
                const student = students.find(function(s) { return s.no === studentNo; });
                
                if (attendanceData[studentNo][week - 1] === 1) {
                    showMessage('âš  Bu hafta iÃ§in yoklama zaten alÄ±nmÄ±ÅŸ!', 'error', 'testResult');
                    return;
                }
                
                attendanceData[studentNo][week - 1] = 1;
                saveAttendanceData();
                
                let weeklyCount = 0;
                students.forEach(function(s) {
                    if (attendanceData[s.no][week - 1] === 1) {
                        weeklyCount++;
                    }
                });
                
                showMessage('âœ… Yoklama baÅŸarÄ±lÄ±! ' + student.name + ' - Hafta ' + week + '<br><strong>ğŸ“Š Bu hafta toplam ' + weeklyCount + ' kiÅŸi yoklama yaptÄ± (42 kiÅŸiden)</strong>', 'success', 'testResult');
                updateReports();
            });
            
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            document.getElementById('startScanBtn').addEventListener('click', startQRScanner);
            document.getElementById('stopScanBtn').addEventListener('click', stopQRScanner);
            
            document.getElementById('teacherLoginBtn').addEventListener('click', teacherLogin);
            document.getElementById('logoutBtn').addEventListener('click', teacherLogout);
            document.getElementById('activeWeekSelect').addEventListener('change', displayActiveWeekQR);
            
            document.getElementById('teacherPasswordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    teacherLogin();
                }
            });
            
            document.getElementById('testLoginBtn').addEventListener('click', testModeLogin);
            document.getElementById('testLogoutBtn').addEventListener('click', testModeLogout);
            
            document.getElementById('testPasswordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testModeLogin();
                }
            });
        });
    </script>
</body>
</html